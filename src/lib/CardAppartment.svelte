<script lang="ts">
	import { createEventDispatcher } from 'svelte';
	import ButtonColored from './ButtonColored.svelte';
	import CarouselImages from './CarouselImages.svelte';
	import Icon from './Icon.svelte';
	import {
		DISPLAY_APPARTMENT_KIND,
		type GeographicPoint,
		type AppartmentKind,
		type Photo
	} from './types';
	import type { Like, TravelTimeToN7, User } from '@prisma/client';
	import { photoURL } from './photos';
	import {
		availableAtSentence,
		distanceBetween,
		distanceDisplay,
		durationDisplay,
		ENSEEIHT,
		isToday
	} from './utils';
	import { tooltip } from './tooltip';
	const emit = createEventDispatcher();

	interface Props {
		photos: Photo[] | null;
		archived: boolean;
		number: number;
		rent: number;
		charges: number;
		surface: number;
		kind: AppartmentKind;
		roomsCount: number;
		travelTimeToN7: TravelTimeToN7 | null;
		availableAt: Date;
		address: string;
		latitude: number | null;
		longitude: number | null;
		hasFurniture: boolean | null;
		hasParking: boolean | null;
		hasBicycleParking: boolean | null;
		hasFiberInternet: boolean | null;
		hasElevator: boolean | null;
		editable?: boolean;
		dislikeable?: boolean;
		small?: boolean;
		likes?: Like[];
	}

	let {
		photos,
		archived,
		number,
		rent,
		charges,
		surface,
		kind,
		roomsCount,
		travelTimeToN7,
		availableAt,
		address,
		latitude,
		longitude,
		hasFurniture,
		hasParking,
		hasBicycleParking,
		hasFiberInternet,
		hasElevator,
		editable = false,
		dislikeable = false,
		small = false,
		likes = []
	}: Props = $props();

	let secondsAvailableSince = (Date.now() - availableAt.valueOf()) * 1e-3;
	let hasCriterias = [
		hasBicycleParking,
		hasElevator,
		hasFiberInternet,
		hasFurniture,
		hasParking
	].some((c) => c !== null);
</script>

<article class:editable class:small class:photo-is-clickable={photos?.length < 2}>
	<section class="photos">
		<svelte:element
			this={photos?.length < 2 ? 'a' : 'div'}
			href={photos?.length < 2 ? `/appartements/${number}` : undefined}
			class="photo-maybe-link"
		>
			<CarouselImages
				cover
				images={photos?.length > 0 ? photos?.map(photoURL) : ['/missing-photo.png']}
			/>
		</svelte:element>
	</section>
	<a class="content" href="/appartements/{number}">
		<section class="figures">
			<section class="price">
				<p class="typo-big-figure rent">{rent + charges}€</p>
				<p class="charges">
					{#if !small}
						dont {charges}€ de charges<br />
					{/if}
					{#if surface > 0}
						soit {Math.round((rent + charges) / surface)} €/m²
					{/if}
				</p>
			</section>
			{#if surface}
				<section class="space">
					<p class="typo-big-figure surface">{surface}m²</p>
					<p class="type">
						{DISPLAY_APPARTMENT_KIND[kind]}
						{#if roomsCount && kind === 'colocation'}<br />de {roomsCount} chambres{/if}
					</p>
				</section>
			{/if}
		</section>
		{#if !small}
			<section class="situation">
				{#if availableAt.valueOf() >= Date.now()}
					<span class="icon"><Icon name="calendar" /></span>
					<p class="when">
						{availableAtSentence(secondsAvailableSince, availableAt)}
						{#if !isToday(availableAt)}
							<span class="muted"
								>{#if secondsAvailableSince > 0}il y a{:else}dans{/if}
								{durationDisplay(Math.abs(secondsAvailableSince))}</span
							>
						{/if}
					</p>
				{/if}
				<span class="icon"><Icon name="location" /></span>
				<p class="where">
					{address}
					{#if latitude && longitude}
						<span class="muted"
							>à {distanceDisplay(
								distanceBetween({ latitude, longitude }, ENSEEIHT)
							)}</span
						>
					{/if}
				</p>
				{#if travelTimeToN7?.byBike || travelTimeToN7?.byFoot || travelTimeToN7?.byPublicTransport}
					<span
						class="icon"
						use:tooltip={"Temps de trajet entre l'école et cet appartement"}
						><Icon name="travel" /></span
					>
					<p class="travel">
						{#if travelTimeToN7.byFoot !== null}
							{durationDisplay(travelTimeToN7.byFoot)} à pied
						{/if}
						{#if travelTimeToN7.byBike !== null}
							, {durationDisplay(travelTimeToN7.byBike)} à vélo
						{/if}
						{#if travelTimeToN7.byPublicTransport !== null}
							, {durationDisplay(travelTimeToN7.byPublicTransport)} en transports<wbr
							/>
						{/if}
					</p>
				{/if}
			</section>

			{#if hasCriterias}
				<section class="criteria">
					{#if hasFurniture !== null}
						<p class="furniture">
							<span class="icon"
								><Icon name="furniture{!hasFurniture ? '-cancel' : ''}" /></span
							>
							{hasFurniture ? 'Meublé' : 'Non meublé'}
						</p>
					{/if}
					{#if hasParking !== null}
						<p class="parking">
							<span class="icon"
								><Icon name="parking{!hasParking ? '-cancel' : ''}" /></span
							>
							{hasParking ? 'Place de parking' : 'Pas de place de parking'}
						</p>
					{/if}
					{#if hasBicycleParking !== null}
						<p class="bicycle-parking">
							<span class="icon"
								><Icon name="bike{!hasBicycleParking ? '-cancel' : ''}" /></span
							>
							{hasBicycleParking ? 'Place pour vélo' : 'Pas de place pour vélo'}
						</p>
					{/if}
					{#if hasFiberInternet !== null}
						<p class="fiber-internet">
							<span class="icon"
								><Icon
									name="fiber-internet{!hasFiberInternet ? '-cancel' : ''}"
								/></span
							>
							{hasFiberInternet ? 'Fibre optique' : 'Pas de fibre optique'}
						</p>
					{/if}
					{#if hasElevator !== null}
						<p class="elevator">
							<span class="icon"
								><Icon name="elevator{!hasElevator ? '-cancel' : ''}" /></span
							>
							{hasElevator ? 'Ascenseur' : "Pas d'ascenseur"}
						</p>
					{/if}
					{#if likes.length > 0}
						<p
							class="likes"
							use:tooltip={(likes.length > 1
								? `${likes.length} personnes sont intéréssées`
								: `Une personne est intéréssée`) + ` par cette annonce`}
						>
							<span class="icon">
								<Icon name="heart" />
							</span>
							{likes.length}
						</p>
					{/if}
				</section>
			{/if}
		{/if}
	</a>
	{#if editable || dislikeable}
		<section class="editable">
			{#if editable}
				<ButtonColored href="/appartements/{number}/modifier">Modifier</ButtonColored>
				{#if !archived}
					<ButtonColored
						on:click={async () => {
							await fetch(`/appartements/${number}/archiver`, { method: 'POST' });
							window.location.reload();
						}}>Archiver</ButtonColored
					>
				{:else}
					<ButtonColored
						on:click={async () => {
							await fetch(`/appartements/${number}/publier`, { method: 'POST' });
							window.location.reload();
						}}>Publier</ButtonColored
					>
				{/if}
				<ButtonColored dangerous href="/appartements/{number}/supprimer"
					>Supprimer</ButtonColored
				>
			{/if}
			{#if dislikeable}
				<ButtonColored dangerous href="/appartements/{number}/supprimer-like"
					>Ne plus suivre</ButtonColored
				>
			{/if}
		</section>
	{/if}
</article>

<style>
	article {
		display: flex;
		flex-direction: column;

		box-shadow: -0.5rem 0.5rem 1rem rgba(0, 0, 0, 0.25);

		background: var(--card-bg, var(--bg));
		border-radius: 1rem;

		overflow: hidden;
		height: 100%;
	}

	.content {
		padding: 1.5em;
		transition: all 0.25s ease;
		flex-grow: 1;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
	}

	section.photos {
		position: relative;
		/* width: 300px; */
		height: 200px;
		/* flex-grow: 1; */
		flex-shrink: 0;
	}

	section.photos .photo-maybe-link {
		display: block;
		height: 100%;
	}

	article.small section.photos {
		height: 150px;
	}

	section.figures {
		display: flex;
		justify-content: space-between;
		margin-bottom: 2em;
		gap: 2rem;
		flex-wrap: wrap;
	}

	section.space {
		display: flex;
		flex-direction: column;
		align-items: end;
		text-align: right;
	}

	section.situation {
		display: grid;
		grid-template-columns: 1.2em 1fr;
		gap: 0.5rem;
		align-items: center;
	}

	section.situation .icon {
		display: inline-block;
		height: 1.2em;
		width: 1.2em;
	}

	p .muted {
		color: var(--muted);
	}

	section.criteria {
		display: flex;
		gap: 1rem;
		margin-top: 1.5rem;
		flex-wrap: wrap;
	}

	section.criteria p {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	section.criteria .icon {
		display: inline-block;
		height: 1.2em;
		width: 1.2em;
	}

	article .content:hover,
	article .content:focus,
	article.photo-is-clickable section.photos:hover + .content,
	article.photo-is-clickable section.photos:focus + .content {
		background: var(--ice);
	}

	section.editable {
		display: flex;
		justify-content: space-between;
		gap: 0.5rem;
		/* margin-top: 2rem; */
		padding: 1.5em;
		/* padding-top: em; */
	}
</style>
